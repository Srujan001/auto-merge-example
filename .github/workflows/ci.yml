name: CI

on:
  push:
    branches:
      - main # Change to your default branch if different
  pull_request:
    branches:
      - main # Change to your default branch if different
    types:
      - opened
      - synchronize
      - reopened

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
    
    - name: Set up Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '14' # Specify the Node.js version you want to use
    
    - name: Install dependencies
      run: npm install # Adjust this command based on your project
    
    - name: Run build
      run: npm run build # Adjust this command based on your project

  auto-merge:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'pull_request' && github.event.pull_request.mergeable == true
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
    
    - name: Auto Merge
      uses: pascalgn/automerge-action@v0.16.4
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        MERGE_LABELS: "automerge,!wip"
        MERGE_METHOD: "squash"
        MERGE_COMMIT_MESSAGE: "pull request #{pullRequest.number} from {pullRequest.head.ref}"

  notify:
    runs-on: ubuntu-latest
    needs: [build, auto-merge]
    if: always()
    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Slack Notification
      uses: slackapi/slack-github-action@v1.24.0
      with:
        payload: |
          {
            "text": "GitHub Actions workflow status for ${{ github.repository }}",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*Workflow:* ${{ github.workflow }}\n*Status:* ${{ job.status }}\n*Repository:* ${{ github.repository }}\n*Ref:* ${{ github.ref }}"
                }
              },
              {
                "type": "actions",
                "elements": [
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "View Workflow"
                    },
                    "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  }
                ]
              }
            ]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
    
    - name: Email Notification
      if: failure()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 465
        username: ${{secrets.EMAIL_USER}}
        password: ${{secrets.EMAIL_PASS}}
        subject: GitHub Actions Workflow Failed - ${{ github.repository }}
        body: |
          Workflow ${{ github.workflow }} of ${{ github.repository }} has failed.
          
          Workflow Details:
          - Repository: ${{ github.repository }}
          - Branch: ${{ github.ref }}
          - Event: ${{ github.event_name }}
          
          Check the full logs here: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        to: srujan.patil07@gmail.com
        from: GitHub Actions
